import{j as e}from"./vendor-ui-CF6Z0xi_.js";import{a as c,b as ee}from"./vendor-react-6Nu9zJZJ.js";import{t as G,u as E,e as te,T as ae,M as se,f as oe}from"./index-D-WjkoAN.js";import"./vendor-state-DWy-Oca_.js";import"./vendor-charts-BiG7rB-8.js";const ne=({stats:r})=>e.jsxs("div",{className:"summaryCards",children:[e.jsxs("div",{className:"summaryCard",children:[e.jsx("div",{className:"summaryLabel",children:"إجمالي العمليات"}),e.jsx("div",{className:"summaryValue",children:r.transactions})]}),e.jsxs("div",{className:"summaryCard added",children:[e.jsx("div",{className:"summaryLabel",children:"المضافة"}),e.jsx("div",{className:"summaryValue",children:r.added})]}),e.jsxs("div",{className:"summaryCard removed",children:[e.jsx("div",{className:"summaryLabel",children:"المباعة"}),e.jsx("div",{className:"summaryValue",children:r.removed})]})]}),re=({filterType:r,setFilterType:h,curtainType:C,setCurtainType:y,colorFilter:I,setColorFilter:N,searchTerm:m,setSearchTerm:n,dateSort:p,setDateSort:T,quantitySort:v,setQuantitySort:x,dateFrom:g,setDateFrom:j,dateTo:D,setDateTo:S,curtainTypes:F,uniqueColors:L,onClearFilters:u,onDeleteAll:l})=>e.jsxs("div",{className:"filterSection",children:[e.jsx("div",{className:"filterGroup",children:e.jsxs("select",{id:"typeFilter",value:r,onChange:s=>h(s.target.value),className:"filterSelect",children:[e.jsx("option",{id:"allId",value:"all",children:"كل العمليات"}),e.jsx("option",{id:"addId",value:"add",children:"إضافة منتجات"}),e.jsx("option",{id:"remvId",value:"remove",children:"بيع منتجات"})]})}),e.jsx("div",{className:"filterGroup",children:e.jsxs("select",{id:"curtainTypeFilter",value:C,onChange:s=>y(s.target.value),className:"filterSelect",children:[e.jsx("option",{id:"valAllId",value:"all",children:"كل الأنواع"}),F.map(s=>e.jsx("option",{id:s.id,value:s.name,children:s.name},s.id))]})}),e.jsx("div",{className:"filterGroup",children:e.jsxs("select",{id:"colorFilter",value:I,onChange:s=>N(s.target.value),className:"filterSelect",children:[e.jsx("option",{id:"valAllColorsId",value:"all",children:"كل الألوان"}),L.map((s,i)=>e.jsx("option",{id:i,value:s,children:s},i))]})}),e.jsx("div",{className:"filterGroup searchGroup",children:e.jsx("input",{id:"search",type:"text",placeholder:"ابحث عن منتج أو نوع أو لون...",value:m,onChange:s=>n(s.target.value),className:"searchInput"})}),e.jsx("div",{className:"filterGroup",children:e.jsxs("select",{id:"dateSortId",value:p,onChange:s=>T(s.target.value),className:"sortSelect",children:[e.jsx("option",{id:"valNewestFirstId",value:"desc",children:"الأحدث أولاً ✓"}),e.jsx("option",{id:"valOldestFirstId",value:"asc",children:"الأقدم أولاً"})]})}),e.jsx("div",{className:"filterGroup",children:e.jsxs("select",{id:"quantitySortId",value:v,onChange:s=>x(s.target.value),className:"sortSelect",children:[e.jsx("option",{id:"valNoSortId",value:"none",children:"بدون ترتيب"}),e.jsx("option",{id:"valLargestFirstId",value:"desc",children:"الأكبر أولاً"}),e.jsx("option",{id:"valSmallestFirstId",value:"asc",children:"الأصغر أولاً"})]})}),e.jsx("div",{className:"filterGroup",children:e.jsx("input",{id:"dateFrom",type:"date",value:g,onChange:s=>j(s.target.value),className:"dateInput"})}),e.jsx("div",{className:"filterGroup",children:e.jsx("input",{id:"dateTo",type:"date",value:D,onChange:s=>S(s.target.value),className:"dateInput",min:g})}),e.jsx("div",{className:"filterGroup",children:e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{className:"actionBtn",onClick:u,style:{backgroundColor:"var(--DT-nestedComponent)",border:"1px solid var(--DT-borderLight)"},children:"مسح الفلاتر"}),e.jsx("button",{className:"actionBtn danger",onClick:l,children:"حذف الكل"})]})})]}),le=({undoBuffer:r,undoCountdown:h,onUndo:C,onClose:y})=>!r||!r.txs||r.txs.length===0?null:e.jsxs("div",{className:"undoSnackbar",role:"status",children:[e.jsxs("div",{className:"undoMessage",children:["تم حذف ",r.txs.length," عملية"]}),e.jsxs("div",{className:"undoCountdown",children:[G(h),"ث"]}),e.jsxs("div",{className:"undoActions",children:[e.jsx("button",{className:"actionBtn",onClick:C,children:"تراجع"}),e.jsx("button",{className:"actionBtn",onClick:y,children:"إغلاق"})]})]}),ie=r=>{const[h,C]=c.useState("all"),[y,I]=c.useState("all"),[N,m]=c.useState("all"),[n,p]=c.useState(""),[T,v]=c.useState("desc"),[x,g]=c.useState("none"),[j,D]=c.useState(""),[S,F]=c.useState(""),L=()=>{C("all"),I("all"),m("all"),p(""),D(""),F(""),v("desc"),g("none")},u=c.useMemo(()=>{let t=r.filter(a=>{const o=h==="all"||a.type===h,f=y==="all"||a.typeName&&a.typeName.trim().toLowerCase()===y.trim().toLowerCase(),k=N==="all"||a.colorName&&a.colorName.trim().toLowerCase()===N.trim().toLowerCase(),$=!n||a.productName&&a.productName.toLowerCase().includes(n.toLowerCase())||a.colorName&&a.colorName.toLowerCase().includes(n.toLowerCase())||a.typeName&&a.typeName.toLowerCase().includes(n.toLowerCase())||a.shapeName&&a.shapeName.toLowerCase().includes(n.toLowerCase())||a.recipientName&&a.recipientName.toLowerCase().includes(n.toLowerCase());let w=!0;if(j||S){const A=new Date(a.date);if(A.setHours(0,0,0,0),j){const b=new Date(j);b.setHours(0,0,0,0),w=w&&A>=b}if(S){const b=new Date(S);b.setHours(23,59,59,999),w=w&&A<=b}}return o&&f&&k&&$&&w});return t.sort((a,o)=>{const f=new Date(a.date),k=new Date(o.date);return T==="desc"?k-f:f-k}),x!=="none"&&t.sort((a,o)=>x==="desc"?o.amount-a.amount:a.amount-o.amount),t},[r,h,n,T,x,y,N,j,S]),l=c.useMemo(()=>{const t=new Map;return r.forEach(a=>{if(a.colorName){const o=a.colorName.trim();o&&!t.has(o.toLowerCase())&&t.set(o.toLowerCase(),o)}}),Array.from(t.values()).sort((a,o)=>a.localeCompare(o))},[r]),s=c.useMemo(()=>{const t=r.filter(o=>o.type==="add").reduce((o,f)=>o+f.amount,0),a=r.filter(o=>o.type==="remove").reduce((o,f)=>o+f.amount,0);return{added:t,removed:a,total:t+a,transactions:r.length}},[r]),i=c.useMemo(()=>u.reduce((t,a)=>t+(a.amount||0),0),[u]);return{filterType:h,setFilterType:C,curtainType:y,setCurtainType:I,colorFilter:N,setColorFilter:m,searchTerm:n,setSearchTerm:p,dateSort:T,setDateSort:v,quantitySort:x,setQuantitySort:g,dateFrom:j,setDateFrom:D,dateTo:S,setDateTo:F,clearAllFilters:L,filteredTransactions:u,uniqueColors:l,stats:s,filteredTotal:i}},ce=(r,h,C,y,I,N,m)=>{const[n,p]=c.useState(null),[T,v]=c.useState(0),[x,g]=c.useState(!1);return c.useEffect(()=>{if(!n?.txs)return;const u=setInterval(()=>{v(l=>l>0?l-1:0)},1e3);return()=>clearInterval(u)},[n?.txs]),{undoBuffer:n,undoCountdown:T,deleteAllOpen:x,setDeleteAllOpen:g,handleDeleteConfirmed:async u=>{try{const l={...u};await h(u.id),n?.timeoutId&&clearTimeout(n.timeoutId);const s=setTimeout(()=>{p(null)},8e3);p(i=>({txs:[...i?.txs||[],l],timeoutId:s})),v(8),m({message:"تم حذف العملية. يمكنك التراجع خلال 8 ثوانٍ.",type:"success",duration:3e3})}catch(l){throw m({message:l.message||"خطأ أثناء حذف العملية",type:"error"}),l}},handleDeleteAllConfirmed:async()=>{const u=[...r],l=[],s=[];for(const i of u)try{await h(i.id),l.push({...i})}catch(t){s.push({tx:i,err:t})}if(l.length>0){n?.timeoutId&&clearTimeout(n.timeoutId);const i=setTimeout(()=>p(null),8e3);p({txs:l,timeoutId:i}),v(8),m({message:`تم حذف ${l.length} عملية. يمكنك التراجع خلال 8 ثوانٍ.`,type:"success"})}s.length>0&&m({message:`فشل حذف ${s.length} عملية بسبب قيود المخزون`,type:"warning"}),g(!1)},handleUndo:async()=>{if(!n?.txs?.length)return;const{txs:u,timeoutId:l}=n;clearTimeout(l);const s=[],i=[];for(const t of u)try{const a=I(t.typeId,t.shapeId,t.variantId)||{inStock:0,sold:0};if(t.type==="add"){const o=(a.inStock||0)+t.amount;y(t.typeId,t.shapeId,t.variantId,o,a.sold||0)}else{if((a.inStock||0)<t.amount)throw new Error("المخزون الحالي لا يكفي لإعادة العملية");const o=(a.inStock||0)-t.amount,f=(a.sold||0)+t.amount;y(t.typeId,t.shapeId,t.variantId,o,f)}C({typeId:t.typeId,shapeId:t.shapeId,variantId:t.variantId,type:t.type,amount:t.amount,date:new Date().toISOString(),typeName:t.typeName,shapeName:t.shapeName,productName:t.productName,colorName:t.colorName,colorCode:t.colorCode,recipientName:t.recipientName,recipientPhone:t.recipientPhone,note:t.note}),s.push(t)}catch(a){i.push({tx:t,err:a})}s.length>0&&m({message:`تم التراجع عن ${s.length} عملية`,type:"success"}),i.length>0&&m({message:`فشل التراجع عن ${i.length} عملية`,type:"error"}),p(null),v(0)},handleEditConfirmed:async(u,l,s={})=>{try{await N(u.id,l,s),m({message:"تم تعديل العملية بنجاح",type:"success"})}catch(i){throw m({message:i.message||"خطأ أثناء تعديل العملية",type:"error"}),i}},closeUndo:()=>{n?.timeoutId&&clearTimeout(n.timeoutId),p(null),v(0)}}},ye=()=>{const r=E(d=>d.transactions),h=E(d=>d.curtainTypes),{modifyTransaction:C,deleteTransactionWithRevert:y}=te(),I=E(d=>d.addTransaction),N=E(d=>d.updateVariantInventory),m=E(d=>d.getProduct),[n,p]=c.useState(null),{filterType:T,setFilterType:v,curtainType:x,setCurtainType:g,colorFilter:j,setColorFilter:D,searchTerm:S,setSearchTerm:F,dateSort:L,setDateSort:u,quantitySort:l,setQuantitySort:s,dateFrom:i,setDateFrom:t,dateTo:a,setDateTo:o,clearAllFilters:f,filteredTransactions:k,uniqueColors:$,stats:w,filteredTotal:A}=ie(r),{undoBuffer:b,undoCountdown:V,deleteAllOpen:Q,setDeleteAllOpen:P,handleDeleteConfirmed:z,handleDeleteAllConfirmed:R,handleUndo:Y,handleEditConfirmed:J,closeUndo:K}=ce(r,y,I,N,m,C,p),W=c.useCallback(d=>{const M=new Date(d),q=M.getFullYear(),U=(M.getMonth()+1).toString().padStart(2,"0"),B=M.getDate().toString().padStart(2,"0");return`${["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"][M.getDay()]}  -  ${G(B)} / ${G(U)} /  ${G(q)}`},[]),X=c.useCallback(d=>{const U=new Date(d).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}).split(" ");let B=U[0];const O=(U[1]||"").toUpperCase(),H=O==="AM"?"ص":O==="PM"?"م":U[1]||"";return`${G(B)} ${H}`},[]),Z=c.useCallback(d=>d==="add"?"إضافة":"سحـب",[]),_=c.useCallback(d=>d==="add"?"type-add":"type-remove",[]);return e.jsxs(e.Fragment,{children:[n&&ee.createPortal(e.jsx(ae,{message:n.message,type:n.type,onClose:()=>p(null)}),document.body),e.jsx(se,{children:e.jsxs("div",{className:"PAGE transactionHistoryPage",children:[e.jsx(ne,{stats:w}),e.jsx(re,{filterType:T,setFilterType:v,curtainType:x,setCurtainType:g,colorFilter:j,setColorFilter:D,searchTerm:S,setSearchTerm:F,dateSort:L,setDateSort:u,quantitySort:l,setQuantitySort:s,dateFrom:i,setDateFrom:t,dateTo:a,setDateTo:o,curtainTypes:h,uniqueColors:$,onClearFilters:f,onDeleteAll:()=>P(!0)}),e.jsx(oe,{transactions:k,filteredTotal:A,totalTransactions:w.transactions,formatDate:W,formatTime:X,getTypeLabel:Z,getTypeClass:_,onDeleteConfirmed:z,onEditConfirmed:J}),Q&&e.jsx("div",{className:"modalOverlay",onClick:()=>P(!1),children:e.jsxs("div",{className:"modalContent",onClick:d=>d.stopPropagation(),children:[e.jsx("h3",{children:"تأكيد حذف الكل"}),e.jsx("p",{children:"هل أنت متأكد من حذف جميع العمليات؟ هذا سيؤدي لإرجاع المخزون لحالته قبل هذه العمليات."}),e.jsxs("div",{style:{textAlign:"right",marginTop:12,display:"flex",gap:5},children:[e.jsx("button",{className:"actionBtn danger",onClick:R,children:"نعم، احذف الكل"}),e.jsx("button",{className:"actionBtn",onClick:()=>P(!1),children:"إلغاء"})]})]})}),e.jsx(le,{undoBuffer:b,undoCountdown:V,onUndo:Y,onClose:K})]})})]})};export{ye as default};
