import{j as e}from"./vendor-ui-8aapSjLi.js";import{a as r,b as se}from"./vendor-react-6Nu9zJZJ.js";import{e as $,t as ne,f as G,u as oe,g as re,T as le,h as ie}from"./index-fUenFpam.js";import{M as ce}from"./MainContainer-CBvf38G3.js";import"./vendor-state-DWy-Oca_.js";import"./vendor-charts-BiG7rB-8.js";const de=(n,p,D,h,F,N,u)=>{const[o,y]=r.useState(null),[w,C]=r.useState(0),[j,b]=r.useState(!1);r.useEffect(()=>{if(!o?.txs)return;const c=setInterval(()=>{C(t=>t>0?t-1:0)},1e3);return()=>clearInterval(c)},[o?.txs]);const x=async c=>{try{const t={...c};await p(c.id),o?.timeoutId&&clearTimeout(o.timeoutId);const v=setTimeout(()=>{y(null)},8e3);y(g=>({txs:[...g?.txs||[],t],timeoutId:v})),C(8),u({message:"تم حذف العملية. يمكنك التراجع خلال 8 ثوانٍ.",type:"success",duration:3e3})}catch(t){throw u({message:t.message||"خطأ أثناء حذف العملية",type:"error"}),t}},k=$(c=>c.deleteAllTransactionsWithRevert);return{undoBuffer:o,undoCountdown:w,deleteAllOpen:j,setDeleteAllOpen:b,handleDeleteConfirmed:x,handleDeleteAllConfirmed:()=>{try{const c=[...n];if(k(),c.length>0){o?.timeoutId&&clearTimeout(o.timeoutId);const t=setTimeout(()=>y(null),8e3);y({txs:c,timeoutId:t}),C(8),u({message:`تم حذف ${c.length} عملية. يمكنك التراجع خلال 8 ثوانٍ.`,type:"success"})}}catch(c){u({message:"حدث خطأ أثناء حذف العمليات",type:"error"}),console.error(c)}b(!1)},handleUndo:async()=>{if(!o?.txs?.length)return;const{txs:c,timeoutId:t}=o;clearTimeout(t);const v=[],g=[];for(const s of c)try{const m=F(s.typeId,s.shapeId,s.variantId)||{inStock:0,sold:0};if(s.type==="add"){const M=(m.inStock||0)+s.amount;h(s.typeId,s.shapeId,s.variantId,M,m.sold||0)}else{if((m.inStock||0)<s.amount)throw new Error("المخزون الحالي لا يكفي لإعادة العملية");const M=(m.inStock||0)-s.amount,O=(m.sold||0)+s.amount;h(s.typeId,s.shapeId,s.variantId,M,O)}D({typeId:s.typeId,shapeId:s.shapeId,variantId:s.variantId,type:s.type,amount:s.amount,date:new Date().toISOString(),typeName:s.typeName,shapeName:s.shapeName,productName:s.productName,colorName:s.colorName,colorCode:s.colorCode,recipientName:s.recipientName,recipientPhone:s.recipientPhone,note:s.note}),v.push(s)}catch(m){g.push({tx:s,err:m})}v.length>0&&u({message:`تم التراجع عن ${v.length} عملية`,type:"success"}),g.length>0&&u({message:`فشل التراجع عن ${g.length} عملية`,type:"error"}),y(null),C(0)},handleEditConfirmed:async(c,t,v={})=>{try{await N(c.id,t,v),u({message:"تم تعديل العملية بنجاح",type:"success"})}catch(g){throw u({message:g.message||"خطأ أثناء تعديل العملية",type:"error"}),g}},closeUndo:()=>{o?.timeoutId&&clearTimeout(o.timeoutId),y(null),C(0)}}},ue=n=>{const[p,D]=r.useState("all"),[h,F]=r.useState("all"),[N,u]=r.useState("all"),[o,y]=r.useState(""),[w,C]=r.useState("desc"),[j,b]=r.useState("none"),[x,k]=r.useState(""),[S,A]=r.useState(""),B=()=>{D("all"),F("all"),u("all"),y(""),k(""),A(""),C("desc"),b("none")},T=r.useMemo(()=>{let d=n.filter(a=>{const l=p==="all"||(p==="remove"?a.type==="remove"||a.type==="sell":a.type===p),f=h==="all"||a.typeName&&a.typeName.trim().toLowerCase()===h.trim().toLowerCase(),L=N==="all"||a.colorName&&a.colorName.trim().toLowerCase()===N.trim().toLowerCase(),I=o.toLowerCase(),W=ne(o),R=!o||a.productName&&a.productName.toLowerCase().includes(I)||a.colorName&&a.colorName.toLowerCase().includes(I)||a.typeName&&a.typeName.toLowerCase().includes(I)||a.shapeName&&a.shapeName.toLowerCase().includes(I)||a.recipientName&&a.recipientName.toLowerCase().includes(I)||a.recipientPhone&&a.recipientPhone.toString().includes(W);let P=!0;if(x||S){const U=new Date(a.date);if(U.setHours(0,0,0,0),x){const E=new Date(x);E.setHours(0,0,0,0),P=P&&U>=E}if(S){const E=new Date(S);E.setHours(23,59,59,999),P=P&&U<=E}}return l&&f&&L&&R&&P});return d.sort((a,l)=>{const f=new Date(a.date),L=new Date(l.date);return w==="desc"?L-f:f-L}),j!=="none"&&d.sort((a,l)=>j==="desc"?l.amount-a.amount:a.amount-l.amount),d},[n,p,o,w,j,h,N,x,S]),c=r.useMemo(()=>{const d=new Map;return n.forEach(a=>{if(a.colorName){const l=a.colorName.trim();l&&!d.has(l.toLowerCase())&&d.set(l.toLowerCase(),l)}}),Array.from(d.values()).sort((a,l)=>a.localeCompare(l))},[n]),t=r.useMemo(()=>{const d=n.filter(l=>l.type==="add").reduce((l,f)=>l+f.amount,0),a=n.filter(l=>l.type==="remove").reduce((l,f)=>l+f.amount,0);return{added:d,removed:a,total:d+a,transactions:n.length}},[n]),v=r.useMemo(()=>T.reduce((d,a)=>d+(a.amount||0),0),[T]),[g,s]=r.useState(1),m=50;r.useMemo(()=>{s(1)},[p,h,N,o,w,j,x,S]);const M=Math.ceil(T.length/m),O=r.useMemo(()=>{const d=(g-1)*m;return T.slice(d,d+m)},[T,g,m]);return{filterType:p,setFilterType:D,curtainType:h,setCurtainType:F,colorFilter:N,setColorFilter:u,searchTerm:o,setSearchTerm:y,dateSort:w,setDateSort:C,quantitySort:j,setQuantitySort:b,dateFrom:x,setDateFrom:k,dateTo:S,setDateTo:A,clearAllFilters:B,filteredTransactions:T,paginatedTransactions:O,uniqueColors:c,stats:t,filteredTotal:v,currentPage:g,setCurrentPage:s,totalPages:M,itemsPerPage:m}},me=({stats:n})=>e.jsxs("div",{className:"summaryCards",children:[e.jsxs("div",{className:"summaryCard",children:[e.jsx("div",{className:"summaryLabel",children:"إجمالي العمليات"}),e.jsx("div",{className:"summaryValue",children:n.transactions})]}),e.jsxs("div",{className:"summaryCard added",children:[e.jsx("div",{className:"summaryLabel",children:"المضافة"}),e.jsx("div",{className:"summaryValue",children:n.added})]}),e.jsxs("div",{className:"summaryCard removed",children:[e.jsx("div",{className:"summaryLabel",children:"المباعة"}),e.jsx("div",{className:"summaryValue",children:n.removed})]})]}),pe=({filterType:n,setFilterType:p,curtainType:D,setCurtainType:h,colorFilter:F,setColorFilter:N,searchTerm:u,setSearchTerm:o,dateSort:y,setDateSort:w,quantitySort:C,setQuantitySort:j,dateFrom:b,setDateFrom:x,dateTo:k,setDateTo:S,curtainTypes:A,uniqueColors:B,onClearFilters:T,onDeleteAll:c})=>e.jsxs("div",{className:"filterSection",children:[e.jsx("div",{className:"filterGroup",children:e.jsxs("select",{id:"typeFilter",value:n,onChange:t=>p(t.target.value),className:"filterSelect",children:[e.jsx("option",{id:"allId",value:"all",children:"كل العمليات"}),e.jsx("option",{id:"addId",value:"add",children:"إضافة منتجات"}),e.jsx("option",{id:"remvId",value:"remove",children:"بيع منتجات"})]})}),e.jsx("div",{className:"filterGroup",children:e.jsxs("select",{id:"curtainTypeFilter",value:D,onChange:t=>h(t.target.value),className:"filterSelect",children:[e.jsx("option",{id:"valAllId",value:"all",children:"كل الأنواع"}),A.map(t=>e.jsx("option",{id:t.id,value:t.name,children:t.name},t.id))]})}),e.jsx("div",{className:"filterGroup",children:e.jsxs("select",{id:"colorFilter",value:F,onChange:t=>N(t.target.value),className:"filterSelect",children:[e.jsx("option",{id:"valAllColorsId",value:"all",children:"كل الألوان"}),B.map((t,v)=>e.jsx("option",{id:v,value:t,children:t},v))]})}),e.jsx("div",{className:"filterGroup searchGroup",children:e.jsx("input",{id:"search",type:"text",placeholder:"ابحث عن منتج أو نوع أو لون...",value:u,onChange:t=>o(t.target.value),className:"searchInput"})}),e.jsx("div",{className:"filterGroup",children:e.jsxs("select",{id:"dateSortId",value:y,onChange:t=>w(t.target.value),className:"sortSelect",children:[e.jsx("option",{id:"valNewestFirstId",value:"desc",children:"الأحدث أولاً ✓"}),e.jsx("option",{id:"valOldestFirstId",value:"asc",children:"الأقدم أولاً"})]})}),e.jsx("div",{className:"filterGroup",children:e.jsxs("select",{id:"quantitySortId",value:C,onChange:t=>j(t.target.value),className:"sortSelect",children:[e.jsx("option",{id:"valNoSortId",value:"none",children:"بدون ترتيب"}),e.jsx("option",{id:"valLargestFirstId",value:"desc",children:"الأكبر أولاً"}),e.jsx("option",{id:"valSmallestFirstId",value:"asc",children:"الأصغر أولاً"})]})}),e.jsx("div",{className:"filterGroup",children:e.jsx("input",{id:"dateFrom",type:"date",value:b,onChange:t=>x(t.target.value),className:"dateInput"})}),e.jsx("div",{className:"filterGroup",children:e.jsx("input",{id:"dateTo",type:"date",value:k,onChange:t=>S(t.target.value),className:"dateInput",min:b})}),e.jsx("div",{className:"filterGroup",children:e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{className:"actionBtn",onClick:T,style:{backgroundColor:"var(--DT-nestedComponent)",border:"1px solid var(--DT-borderLight)"},children:"مسح الفلاتر"}),e.jsx("button",{className:"actionBtn danger",onClick:c,children:"حذف الكل"})]})})]}),he=({undoBuffer:n,undoCountdown:p,onUndo:D,onClose:h})=>!n||!n.txs||n.txs.length===0?null:e.jsxs("div",{className:"undoSnackbar",role:"status",children:[e.jsxs("div",{className:"undoMessage",children:["تم حذف ",n.txs.length," عملية"]}),e.jsxs("div",{className:"undoCountdown",children:[G(p),"ث"]}),e.jsxs("div",{className:"undoActions",children:[e.jsx("button",{className:"actionBtn",onClick:D,children:"تراجع"}),e.jsx("button",{className:"actionBtn",onClick:h,children:"إغلاق"})]})]}),Ne=()=>{oe("History Page");const n=$(i=>i.transactions),p=$(i=>i.curtainTypes),{modifyTransaction:D,deleteTransactionWithRevert:h}=re(),F=$(i=>i.addTransaction),N=$(i=>i.updateVariantInventory),u=$(i=>i.getProduct),[o,y]=r.useState(null),{filterType:w,setFilterType:C,curtainType:j,setCurtainType:b,colorFilter:x,setColorFilter:k,searchTerm:S,setSearchTerm:A,dateSort:B,setDateSort:T,quantitySort:c,setQuantitySort:t,dateFrom:v,setDateFrom:g,dateTo:s,setDateTo:m,clearAllFilters:M,uniqueColors:O,stats:d,filteredTotal:a,paginatedTransactions:l,currentPage:f,setCurrentPage:L,totalPages:I}=ue(n),{undoBuffer:W,undoCountdown:R,deleteAllOpen:P,setDeleteAllOpen:U,handleDeleteConfirmed:E,handleDeleteAllConfirmed:J,handleUndo:K,handleEditConfirmed:X,closeUndo:Z}=de(n,h,F,N,u,D,y),_=r.useCallback(i=>{const H=new Date(i),Q=H.getFullYear(),q=(H.getMonth()+1).toString().padStart(2,"0"),V=H.getDate().toString().padStart(2,"0");return`${["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"][H.getDay()]}  -  ${G(V)} / ${G(q)} /  ${G(Q)}`},[]),ee=r.useCallback(i=>{const q=new Date(i).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}).split(" ");let V=q[0];const z=(q[1]||"").toUpperCase(),Y=z==="AM"?"ص":z==="PM"?"م":q[1]||"";return`${G(V)} ${Y}`},[]),te=r.useCallback(i=>i==="add"?"إضافة":"سحـب",[]),ae=r.useCallback(i=>i==="add"?"type-add":"type-remove",[]);return e.jsxs(e.Fragment,{children:[o&&se.createPortal(e.jsx(le,{message:o.message,type:o.type,onClose:()=>y(null)}),document.body),e.jsx(ce,{children:e.jsxs("div",{className:"PAGE transactionHistoryPage",children:[e.jsx(me,{stats:d}),e.jsx(pe,{filterType:w,setFilterType:C,curtainType:j,setCurtainType:b,colorFilter:x,setColorFilter:k,searchTerm:S,setSearchTerm:A,dateSort:B,setDateSort:T,quantitySort:c,setQuantitySort:t,dateFrom:v,setDateFrom:g,dateTo:s,setDateTo:m,curtainTypes:p,uniqueColors:O,onClearFilters:M,onDeleteAll:()=>U(!0)}),e.jsx(ie,{transactions:l,filteredTotal:a,totalTransactions:d.transactions,formatDate:_,formatTime:ee,getTypeLabel:te,getTypeClass:ae,onDeleteConfirmed:E,onEditConfirmed:X}),I>1&&e.jsxs("div",{className:"paginationControls",style:{display:"flex",justifyContent:"center",alignItems:"center",gap:"15px",marginTop:"20px",paddingBottom:"20px"},children:[e.jsx("button",{className:"actionBtn",onClick:()=>L(i=>Math.max(1,i-1)),disabled:f===1,style:{opacity:f===1?.5:1},children:"السابق"}),e.jsxs("span",{style:{fontSize:"1rem",fontWeight:"bold",color:"var(--DT-text)"},children:["صفحة ",G(f)," من ",G(I)]}),e.jsx("button",{className:"actionBtn",onClick:()=>L(i=>Math.min(I,i+1)),disabled:f===I,style:{opacity:f===I?.5:1},children:"التالي"})]}),P&&e.jsx("div",{className:"modalOverlay",onClick:()=>U(!1),children:e.jsxs("div",{className:"modalContent",onClick:i=>i.stopPropagation(),children:[e.jsx("h3",{children:"تأكيد حذف الكل"}),e.jsx("p",{children:"هل أنت متأكد من حذف جميع العمليات؟ هذا سيؤدي لإرجاع المخزون لحالته قبل هذه العمليات."}),e.jsxs("div",{style:{textAlign:"right",marginTop:12,display:"flex",gap:5},children:[e.jsx("button",{className:"actionBtn danger",onClick:J,children:"نعم، احذف الكل"}),e.jsx("button",{className:"actionBtn",onClick:()=>U(!1),children:"إلغاء"})]})]})}),e.jsx(he,{undoBuffer:W,undoCountdown:R,onUndo:K,onClose:Z})]})})]})};export{Ne as default};
