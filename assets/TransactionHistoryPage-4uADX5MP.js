import{j as e}from"./vendor-ui-8aapSjLi.js";import{a as r,b as se}from"./vendor-react-6Nu9zJZJ.js";import{t as E,d as B,e as oe,T as ne,f as re}from"./index-BO56jMQy.js";import{M as le}from"./MainContainer-FjmAJ0nv.js";import"./vendor-state-DWy-Oca_.js";import"./vendor-charts-BiG7rB-8.js";const ie=({stats:n})=>e.jsxs("div",{className:"summaryCards",children:[e.jsxs("div",{className:"summaryCard",children:[e.jsx("div",{className:"summaryLabel",children:"إجمالي العمليات"}),e.jsx("div",{className:"summaryValue",children:n.transactions})]}),e.jsxs("div",{className:"summaryCard added",children:[e.jsx("div",{className:"summaryLabel",children:"المضافة"}),e.jsx("div",{className:"summaryValue",children:n.added})]}),e.jsxs("div",{className:"summaryCard removed",children:[e.jsx("div",{className:"summaryLabel",children:"المباعة"}),e.jsx("div",{className:"summaryValue",children:n.removed})]})]}),ce=({filterType:n,setFilterType:p,curtainType:I,setCurtainType:h,colorFilter:b,setColorFilter:N,searchTerm:u,setSearchTerm:o,dateSort:y,setDateSort:w,quantitySort:f,setQuantitySort:j,dateFrom:D,setDateFrom:x,dateTo:F,setDateTo:S,curtainTypes:k,uniqueColors:G,onClearFilters:T,onDeleteAll:c})=>e.jsxs("div",{className:"filterSection",children:[e.jsx("div",{className:"filterGroup",children:e.jsxs("select",{id:"typeFilter",value:n,onChange:t=>p(t.target.value),className:"filterSelect",children:[e.jsx("option",{id:"allId",value:"all",children:"كل العمليات"}),e.jsx("option",{id:"addId",value:"add",children:"إضافة منتجات"}),e.jsx("option",{id:"remvId",value:"remove",children:"بيع منتجات"})]})}),e.jsx("div",{className:"filterGroup",children:e.jsxs("select",{id:"curtainTypeFilter",value:I,onChange:t=>h(t.target.value),className:"filterSelect",children:[e.jsx("option",{id:"valAllId",value:"all",children:"كل الأنواع"}),k.map(t=>e.jsx("option",{id:t.id,value:t.name,children:t.name},t.id))]})}),e.jsx("div",{className:"filterGroup",children:e.jsxs("select",{id:"colorFilter",value:b,onChange:t=>N(t.target.value),className:"filterSelect",children:[e.jsx("option",{id:"valAllColorsId",value:"all",children:"كل الألوان"}),G.map((t,v)=>e.jsx("option",{id:v,value:t,children:t},v))]})}),e.jsx("div",{className:"filterGroup searchGroup",children:e.jsx("input",{id:"search",type:"text",placeholder:"ابحث عن منتج أو نوع أو لون...",value:u,onChange:t=>o(t.target.value),className:"searchInput"})}),e.jsx("div",{className:"filterGroup",children:e.jsxs("select",{id:"dateSortId",value:y,onChange:t=>w(t.target.value),className:"sortSelect",children:[e.jsx("option",{id:"valNewestFirstId",value:"desc",children:"الأحدث أولاً ✓"}),e.jsx("option",{id:"valOldestFirstId",value:"asc",children:"الأقدم أولاً"})]})}),e.jsx("div",{className:"filterGroup",children:e.jsxs("select",{id:"quantitySortId",value:f,onChange:t=>j(t.target.value),className:"sortSelect",children:[e.jsx("option",{id:"valNoSortId",value:"none",children:"بدون ترتيب"}),e.jsx("option",{id:"valLargestFirstId",value:"desc",children:"الأكبر أولاً"}),e.jsx("option",{id:"valSmallestFirstId",value:"asc",children:"الأصغر أولاً"})]})}),e.jsx("div",{className:"filterGroup",children:e.jsx("input",{id:"dateFrom",type:"date",value:D,onChange:t=>x(t.target.value),className:"dateInput"})}),e.jsx("div",{className:"filterGroup",children:e.jsx("input",{id:"dateTo",type:"date",value:F,onChange:t=>S(t.target.value),className:"dateInput",min:D})}),e.jsx("div",{className:"filterGroup",children:e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{className:"actionBtn",onClick:T,style:{backgroundColor:"var(--DT-nestedComponent)",border:"1px solid var(--DT-borderLight)"},children:"مسح الفلاتر"}),e.jsx("button",{className:"actionBtn danger",onClick:c,children:"حذف الكل"})]})})]}),de=({undoBuffer:n,undoCountdown:p,onUndo:I,onClose:h})=>!n||!n.txs||n.txs.length===0?null:e.jsxs("div",{className:"undoSnackbar",role:"status",children:[e.jsxs("div",{className:"undoMessage",children:["تم حذف ",n.txs.length," عملية"]}),e.jsxs("div",{className:"undoCountdown",children:[E(p),"ث"]}),e.jsxs("div",{className:"undoActions",children:[e.jsx("button",{className:"actionBtn",onClick:I,children:"تراجع"}),e.jsx("button",{className:"actionBtn",onClick:h,children:"إغلاق"})]})]}),ue=n=>{const[p,I]=r.useState("all"),[h,b]=r.useState("all"),[N,u]=r.useState("all"),[o,y]=r.useState(""),[w,f]=r.useState("desc"),[j,D]=r.useState("none"),[x,F]=r.useState(""),[S,k]=r.useState(""),G=()=>{I("all"),b("all"),u("all"),y(""),F(""),k(""),f("desc"),D("none")},T=r.useMemo(()=>{let d=n.filter(a=>{const l=p==="all"||(p==="remove"?a.type==="remove"||a.type==="sell":a.type===p),g=h==="all"||a.typeName&&a.typeName.trim().toLowerCase()===h.trim().toLowerCase(),A=N==="all"||a.colorName&&a.colorName.trim().toLowerCase()===N.trim().toLowerCase(),M=!o||a.productName&&a.productName.toLowerCase().includes(o.toLowerCase())||a.colorName&&a.colorName.toLowerCase().includes(o.toLowerCase())||a.typeName&&a.typeName.toLowerCase().includes(o.toLowerCase())||a.shapeName&&a.shapeName.toLowerCase().includes(o.toLowerCase())||a.recipientName&&a.recipientName.toLowerCase().includes(o.toLowerCase());let P=!0;if(x||S){const O=new Date(a.date);if(O.setHours(0,0,0,0),x){const U=new Date(x);U.setHours(0,0,0,0),P=P&&O>=U}if(S){const U=new Date(S);U.setHours(23,59,59,999),P=P&&O<=U}}return l&&g&&A&&M&&P});return d.sort((a,l)=>{const g=new Date(a.date),A=new Date(l.date);return w==="desc"?A-g:g-A}),j!=="none"&&d.sort((a,l)=>j==="desc"?l.amount-a.amount:a.amount-l.amount),d},[n,p,o,w,j,h,N,x,S]),c=r.useMemo(()=>{const d=new Map;return n.forEach(a=>{if(a.colorName){const l=a.colorName.trim();l&&!d.has(l.toLowerCase())&&d.set(l.toLowerCase(),l)}}),Array.from(d.values()).sort((a,l)=>a.localeCompare(l))},[n]),t=r.useMemo(()=>{const d=n.filter(l=>l.type==="add").reduce((l,g)=>l+g.amount,0),a=n.filter(l=>l.type==="remove").reduce((l,g)=>l+g.amount,0);return{added:d,removed:a,total:d+a,transactions:n.length}},[n]),v=r.useMemo(()=>T.reduce((d,a)=>d+(a.amount||0),0),[T]),[C,s]=r.useState(1),m=50;r.useMemo(()=>{s(1)},[p,h,N,o,w,j,x,S]);const L=Math.ceil(T.length/m),$=r.useMemo(()=>{const d=(C-1)*m;return T.slice(d,d+m)},[T,C,m]);return{filterType:p,setFilterType:I,curtainType:h,setCurtainType:b,colorFilter:N,setColorFilter:u,searchTerm:o,setSearchTerm:y,dateSort:w,setDateSort:f,quantitySort:j,setQuantitySort:D,dateFrom:x,setDateFrom:F,dateTo:S,setDateTo:k,clearAllFilters:G,filteredTransactions:T,paginatedTransactions:$,uniqueColors:c,stats:t,filteredTotal:v,currentPage:C,setCurrentPage:s,totalPages:L,itemsPerPage:m}},me=(n,p,I,h,b,N,u)=>{const[o,y]=r.useState(null),[w,f]=r.useState(0),[j,D]=r.useState(!1);r.useEffect(()=>{if(!o?.txs)return;const c=setInterval(()=>{f(t=>t>0?t-1:0)},1e3);return()=>clearInterval(c)},[o?.txs]);const x=async c=>{try{const t={...c};await p(c.id),o?.timeoutId&&clearTimeout(o.timeoutId);const v=setTimeout(()=>{y(null)},8e3);y(C=>({txs:[...C?.txs||[],t],timeoutId:v})),f(8),u({message:"تم حذف العملية. يمكنك التراجع خلال 8 ثوانٍ.",type:"success",duration:3e3})}catch(t){throw u({message:t.message||"خطأ أثناء حذف العملية",type:"error"}),t}},F=B(c=>c.deleteAllTransactionsWithRevert);return{undoBuffer:o,undoCountdown:w,deleteAllOpen:j,setDeleteAllOpen:D,handleDeleteConfirmed:x,handleDeleteAllConfirmed:()=>{try{const c=[...n];if(F(),c.length>0){o?.timeoutId&&clearTimeout(o.timeoutId);const t=setTimeout(()=>y(null),8e3);y({txs:c,timeoutId:t}),f(8),u({message:`تم حذف ${c.length} عملية. يمكنك التراجع خلال 8 ثوانٍ.`,type:"success"})}}catch(c){u({message:"حدث خطأ أثناء حذف العمليات",type:"error"}),console.error(c)}D(!1)},handleUndo:async()=>{if(!o?.txs?.length)return;const{txs:c,timeoutId:t}=o;clearTimeout(t);const v=[],C=[];for(const s of c)try{const m=b(s.typeId,s.shapeId,s.variantId)||{inStock:0,sold:0};if(s.type==="add"){const L=(m.inStock||0)+s.amount;h(s.typeId,s.shapeId,s.variantId,L,m.sold||0)}else{if((m.inStock||0)<s.amount)throw new Error("المخزون الحالي لا يكفي لإعادة العملية");const L=(m.inStock||0)-s.amount,$=(m.sold||0)+s.amount;h(s.typeId,s.shapeId,s.variantId,L,$)}I({typeId:s.typeId,shapeId:s.shapeId,variantId:s.variantId,type:s.type,amount:s.amount,date:new Date().toISOString(),typeName:s.typeName,shapeName:s.shapeName,productName:s.productName,colorName:s.colorName,colorCode:s.colorCode,recipientName:s.recipientName,recipientPhone:s.recipientPhone,note:s.note}),v.push(s)}catch(m){C.push({tx:s,err:m})}v.length>0&&u({message:`تم التراجع عن ${v.length} عملية`,type:"success"}),C.length>0&&u({message:`فشل التراجع عن ${C.length} عملية`,type:"error"}),y(null),f(0)},handleEditConfirmed:async(c,t,v={})=>{try{await N(c.id,t,v),u({message:"تم تعديل العملية بنجاح",type:"success"})}catch(C){throw u({message:C.message||"خطأ أثناء تعديل العملية",type:"error"}),C}},closeUndo:()=>{o?.timeoutId&&clearTimeout(o.timeoutId),y(null),f(0)}}},fe=()=>{const n=B(i=>i.transactions),p=B(i=>i.curtainTypes),{modifyTransaction:I,deleteTransactionWithRevert:h}=oe(),b=B(i=>i.addTransaction),N=B(i=>i.updateVariantInventory),u=B(i=>i.getProduct),[o,y]=r.useState(null),{filterType:w,setFilterType:f,curtainType:j,setCurtainType:D,colorFilter:x,setColorFilter:F,searchTerm:S,setSearchTerm:k,dateSort:G,setDateSort:T,quantitySort:c,setQuantitySort:t,dateFrom:v,setDateFrom:C,dateTo:s,setDateTo:m,clearAllFilters:L,uniqueColors:$,stats:d,filteredTotal:a,paginatedTransactions:l,currentPage:g,setCurrentPage:A,totalPages:M}=ue(n),{undoBuffer:P,undoCountdown:O,deleteAllOpen:U,setDeleteAllOpen:R,handleDeleteConfirmed:Y,handleDeleteAllConfirmed:J,handleUndo:K,handleEditConfirmed:X,closeUndo:Z}=me(n,h,b,N,u,I,y),_=r.useCallback(i=>{const q=new Date(i),z=q.getFullYear(),H=(q.getMonth()+1).toString().padStart(2,"0"),V=q.getDate().toString().padStart(2,"0");return`${["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"][q.getDay()]}  -  ${E(V)} / ${E(H)} /  ${E(z)}`},[]),ee=r.useCallback(i=>{const H=new Date(i).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}).split(" ");let V=H[0];const W=(H[1]||"").toUpperCase(),Q=W==="AM"?"ص":W==="PM"?"م":H[1]||"";return`${E(V)} ${Q}`},[]),te=r.useCallback(i=>i==="add"?"إضافة":"سحـب",[]),ae=r.useCallback(i=>i==="add"?"type-add":"type-remove",[]);return e.jsxs(e.Fragment,{children:[o&&se.createPortal(e.jsx(ne,{message:o.message,type:o.type,onClose:()=>y(null)}),document.body),e.jsx(le,{children:e.jsxs("div",{className:"PAGE transactionHistoryPage",children:[e.jsx(ie,{stats:d}),e.jsx(ce,{filterType:w,setFilterType:f,curtainType:j,setCurtainType:D,colorFilter:x,setColorFilter:F,searchTerm:S,setSearchTerm:k,dateSort:G,setDateSort:T,quantitySort:c,setQuantitySort:t,dateFrom:v,setDateFrom:C,dateTo:s,setDateTo:m,curtainTypes:p,uniqueColors:$,onClearFilters:L,onDeleteAll:()=>R(!0)}),e.jsx(re,{transactions:l,filteredTotal:a,totalTransactions:d.transactions,formatDate:_,formatTime:ee,getTypeLabel:te,getTypeClass:ae,onDeleteConfirmed:Y,onEditConfirmed:X}),M>1&&e.jsxs("div",{className:"paginationControls",style:{display:"flex",justifyContent:"center",alignItems:"center",gap:"15px",marginTop:"20px",paddingBottom:"20px"},children:[e.jsx("button",{className:"actionBtn",onClick:()=>A(i=>Math.max(1,i-1)),disabled:g===1,style:{opacity:g===1?.5:1},children:"السابق"}),e.jsxs("span",{style:{fontSize:"1rem",fontWeight:"bold",color:"var(--DT-text)"},children:["صفحة ",E(g)," من ",E(M)]}),e.jsx("button",{className:"actionBtn",onClick:()=>A(i=>Math.min(M,i+1)),disabled:g===M,style:{opacity:g===M?.5:1},children:"التالي"})]}),U&&e.jsx("div",{className:"modalOverlay",onClick:()=>R(!1),children:e.jsxs("div",{className:"modalContent",onClick:i=>i.stopPropagation(),children:[e.jsx("h3",{children:"تأكيد حذف الكل"}),e.jsx("p",{children:"هل أنت متأكد من حذف جميع العمليات؟ هذا سيؤدي لإرجاع المخزون لحالته قبل هذه العمليات."}),e.jsxs("div",{style:{textAlign:"right",marginTop:12,display:"flex",gap:5},children:[e.jsx("button",{className:"actionBtn danger",onClick:J,children:"نعم، احذف الكل"}),e.jsx("button",{className:"actionBtn",onClick:()=>R(!1),children:"إلغاء"})]})]})}),e.jsx(de,{undoBuffer:P,undoCountdown:O,onUndo:K,onClose:Z})]})})]})};export{fe as default};
